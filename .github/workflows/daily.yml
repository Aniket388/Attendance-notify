name: Daily Attendance Check

on:
  schedule:
    # ‚è∞ SCHEDULE (UTC TIME)
    # India (IST) is UTC + 5:30.
    # 6:30 AM IST = 1:00 AM UTC
    #- cron: '0 1 * * *'
    # ‚è∞ TEST SCHEDULE (UTC TIME)
    # 11:30 AM UTC = 5:00 PM IST
    #- cron: '30 11 * * *'
    # ‚è∞ OFF-PEAK TEST: 6:57 PM IST (1:27 PM UTC)
    # Using a "random" minute (27) to bypass server traffic.
    #- cron: '27 13 * * *'
    # ‚è∞ FINAL SCHEDULE
    # 5:52 AM IST = 00:22 AM UTC
    - cron: '22 0 * * *'
    





  # Keep manual trigger for testing
  workflow_dispatch:

jobs:
  check-attendance:
    runs-on: ubuntu-latest
    
    # üöÄ PARALLEL STRATEGY (THE MATRIX)
    strategy:
      fail-fast: false  # If one worker fails, don't kill the others!
      matrix:
        # We create 4 Workers (0, 1, 2, 3)
        # This will spin up 4 computers simultaneously
        shard: [0, 1, 2, 3]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install Libraries
        run: pip install selenium webdriver-manager supabase cryptography google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client

      - name: Run Matrix Worker
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          MASTER_KEY: ${{ secrets.MASTER_KEY }}
          GMAIL_TOKEN_JSON: ${{ secrets.GMAIL_TOKEN_JSON }}
        # üÉè THE MAGIC: "I am Shard X out of 4"
        run: python attendance.py --shard_id ${{ matrix.shard }} --total_shards 4
